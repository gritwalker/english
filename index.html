<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¤‘í•™êµ ì˜ì–´ êµê³¼ì„œ ì•”ê¸° íŠ¸ë ˆì´ë„ˆ (7ê³¼/8ê³¼)</title>
    <!-- Tailwind CSS ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ì‚¬ìš©ì ì •ì˜ ìŠ¤íƒ€ì¼ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            color: #1f2937;
            touch-action: manipulation; /* ëª¨ë°”ì¼ì—ì„œ íƒ­ ë°˜ì‘ì„± í–¥ìƒ */
        }
        .container-wrapper {
            max-width: 900px;
            margin: 0 auto;
            padding: 1rem;
        }
        .text-display {
            white-space: pre-wrap; /* ì¤„ ë°”ê¿ˆ ìœ ì§€ */
            line-height: 1.5;
            font-size: 1.125rem;
            min-height: 160px;
        }
        /* ë¹ˆì¹¸ ìŠ¤íƒ€ì¼ */
        .masked-word {
            color: transparent; /* í…ìŠ¤íŠ¸ ìˆ¨ê¸°ê¸° */
            background-color: #e0e7ff; /* ë¹ˆì¹¸ ë°°ê²½ìƒ‰ */
            border-radius: 3px;
            padding: 0 2px;
            margin: 0 2px;
            font-weight: 600;
            display: inline-block;
            line-height: 1.0;
            vertical-align: baseline;
            min-width: 1.2rem; /* ë¹ˆì¹¸ ìµœì†Œ ë„ˆë¹„ */
            transition: background-color 0.15s ease;
        }
        .masked-word.show-answer {
            color: #1f2937; /* ì •ë‹µ ë³´ê¸° ëª¨ë“œì¼ ë•Œ í…ìŠ¤íŠ¸ í‘œì‹œ */
            background-color: #d1fae5;
        }
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn {
            @apply px-4 py-2 font-semibold text-white rounded-lg transition duration-150 ease-in-out shadow-md;
        }
        .btn-primary {
            @apply bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50;
        }
        .btn-secondary {
            @apply bg-gray-500 hover:bg-gray-600 focus:outline-none focus:ring-4 focus:ring-gray-400 focus:ring-opacity-50;
        }
        .btn-green {
            @apply bg-emerald-600 hover:bg-emerald-700 focus:outline-none focus:ring-4 focus:ring-emerald-500 focus:ring-opacity-50;
        }
        .btn-audio {
             @apply bg-pink-600 hover:bg-pink-700 focus:outline-none focus:ring-4 focus:ring-pink-500 focus:ring-opacity-50;
        }
        .btn:disabled {
            @apply opacity-50 cursor-not-allowed;
        }
        textarea {
            resize: vertical;
        }
        .status-message {
            @apply text-sm mt-2 p-2 rounded-lg text-center;
        }
        .status-error {
            @apply bg-red-100 text-red-700;
        }
        .status-loading {
            @apply bg-blue-100 text-blue-700;
        }
        /* ë¬¸ì¥ ì¹´ë“œ + ìŠ¤í”¼ì»¤ ì•„ì´ì½˜ */
        .sentence-row { display: flex; align-items: flex-start; gap: 0.5rem; margin-bottom: 0.75rem; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 0.75rem; }
        .sentence-text { flex: 1; }
        .sentence-speaker { @apply inline-flex items-center justify-center w-8 h-8 rounded-md bg-indigo-100 text-indigo-700 hover:bg-indigo-200; }
        /* ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 640px) {
            .container-wrapper { padding: 0.75rem; }
            .text-display { font-size: 1rem; line-height: 1.45; }
            .btn { font-size: 0.875rem; padding: 0.5rem 0.75rem; }
        }
    </style>
</head>
<body>

    <div class="container-wrapper">
        <header class="text-center py-6">
        </header>

        <main id="app-container">

            <!-- 1. ë³¸ë¬¸ ì„ íƒ ì„¹ì…˜ -->
            <div id="input-section" class="bg-white p-6 rounded-xl shadow-lg mb-6 border border-gray-200">
                <h2 class="text-xl font-semibold mb-3 text-indigo-600">1ë‹¨ê³„: ì™¸ìš¸ ê³¼ ì„ íƒ</h2>
                <p class="text-gray-600 mb-4">í•™ìŠµí•  ê³¼(Lesson)ë¥¼ ì„ íƒí•˜ì„¸ìš”. (ê³ í’ˆì§ˆ TTS ì‚¬ìš©)</p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button onclick="processText(LESSON_7_SCRIPT, 'Lesson 7: Rada\'s New World')" class="btn btn-primary w-full">
                        Lesson 7 ìŠ¤í¬ë¦½íŠ¸ ì™¸ìš°ê¸°
                    </button>
                    <button onclick="processText(LESSON_8_SCRIPT, 'Lesson 8: Uigwe and Jikji')" class="btn btn-primary w-full">
                        Lesson 8 ìŠ¤í¬ë¦½íŠ¸ ì™¸ìš°ê¸°
                    </button>
                </div>
                <div id="tts-status-message-initial" class="status-message hidden mt-4"></div>
            </div>

            <!-- 2. ì•”ê¸° ëª¨ë“œ ì„¹ì…˜ -->
            <div id="memorization-section" class="hidden">

                <!-- ë‚œì´ë„ ì¡°ì ˆ ë° ìƒíƒœ -->
                <div class="bg-white p-6 rounded-xl shadow-lg mb-6 border border-gray-200">
                    <h2 id="lesson-title" class="text-xl font-semibold mb-3 text-indigo-600">2ë‹¨ê³„: ë¹ˆì¹¸ ì±„ìš°ë©° ì™¸ìš°ê¸°</h2>
                    
                    <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
                        <span id="current-difficulty-display" class="text-lg font-medium text-gray-700">ë‚œì´ë„: ì‰¬ì›€ (0% ê°€ë¦¼)</span>
                        <div class="flex gap-2">
                            <button id="toggle-answer-btn" onclick="toggleAnswer()" class="btn btn-green">
                                ì •ë‹µ ë³´ê¸°/ìˆ¨ê¸°ê¸°
                            </button>
                            <button id="audio-btn" onclick="toggleAudio()" class="btn btn-audio">
                                ğŸ”Š ìŒì„± ë“£ê¸°
                            </button>
                        </div>
                    </div>

                    <div id="tts-status-message" class="hidden status-message"></div>

                    <div class="flex flex-wrap justify-center gap-3 mt-4">
                        <button onclick="setDifficulty(0)" class="btn btn-secondary w-20">0%</button>
                        <button onclick="setDifficulty(1)" class="btn btn-secondary w-20">20%</button>
                        <button onclick="setDifficulty(2)" class="btn btn-secondary w-20">40%</button>
                        <button onclick="setDifficulty(3)" class="btn btn-secondary w-20">60%</button>
                        <button onclick="setDifficulty(4)" class="btn btn-secondary w-20">80%</button>
                        <button onclick="setDifficulty(5)" class="btn btn-secondary w-20">100%</button>
                    </div>
                    <p class="text-sm text-gray-500 mt-2 text-center">ë‚œì´ë„ê°€ ë†’ì„ìˆ˜ë¡ ê· í˜• ìˆê²Œ ë” ë§ì€ ë‹¨ì–´ê°€ ê°€ë ¤ì§‘ë‹ˆë‹¤.</p>
                </div>

                <!-- ë³¸ë¬¸ í‘œì‹œ ì˜ì—­ -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h3 class="text-lg font-semibold mb-4 border-b pb-2 text-gray-800">
                        í˜ì´ì§€ <span id="current-page-display">1</span> / <span id="total-pages-display">1</span>
                    </h3>
                    <div id="text-display-area" class="text-display text-gray-800">
                        ì—¬ê¸°ì— ì•”ê¸°í•  ë³¸ë¬¸ì´ í‘œì‹œë©ë‹ˆë‹¤.
                    </div>
                </div>

                <!-- í˜ì´ì§€ë„¤ì´ì…˜ ë° ì´ˆê¸°í™” ë²„íŠ¼ -->
                <div class="mt-6 flex flex-col sm:flex-row justify-between gap-4">
                    <div class="flex gap-2 sm:w-1/2">
                        <button id="prev-page-btn" onclick="goToPrevPage()" class="btn btn-primary w-full sm:w-auto" disabled>
                            &lt; ì´ì „ í˜ì´ì§€
                        </button>
                        <button id="next-page-btn" onclick="goToNextPage()" class="btn btn-primary w-full sm:w-auto" disabled>
                            ë‹¤ìŒ í˜ì´ì§€ &gt;
                        </button>
                    </div>
                    <button onclick="resetApp()" class="btn btn-secondary sm:w-1/2">
                        ë‹¤ë¥¸ ê³¼ ì„ íƒ / ì´ˆê¸°í™”
                    </button>
                </div>
            </div>

        </main>

        <footer class="text-center text-sm text-gray-500 mt-8 py-4">
            &copy; 2024 ì˜ì–´ ì•”ê¸° ë„ìš°ë¯¸.
        </footer>
    </div>

    <script>
        // --- Lesson Scripts ---
        const LESSON_7_SCRIPT = `Rada lived on a little world, far out in space. She lived there with her father, mother, and brother Jonny.

Radaâ€™s father and other people worked on spaceships. Only Rada and Jonny were children, and they were born in space.

One day, Dad told Rada and Jonny, â€œWeâ€™re going back to Earth tomorrow.â€

Rada and Jonny looked at Dad in surprise and floated towards him.
Rada asked Dad, â€œWhatâ€™s it like on Earth?â€

â€œEverything is different there. For example, the sky is blue,â€ answered Dad.

â€œIâ€™ve never seen a blue sky,â€ said Jonny.

â€œThe sky is always black here,â€ said Rada.

â€œYou donâ€™t have to wear your big heavy space suits because there is air everywhere.

It's also hard to jump there because Earth pulls you down,â€ said Dad.

â€œWhat else?â€ asked Rada.

â€œThere are hills, and they are covered with soft green grass.

You can roll down the hills,â€ answered Mom.

â€œDad, have you ever rolled down a hill?â€ asked Rada.

â€œYes, itâ€™s really amazing!â€ answered Dad.

Jonny was thirsty, so he opened a milk container and shook it.

The milk floated in the air and formed balls.

Jonny swallowed the balls.

â€œJonny, if you drink milk that way on Earth, youâ€™ll get wet,â€ said Mom.

Later that night, Rada and Jonny talked a long time about Earth.

It was exciting to think about all the new things they were going to see and do.

There was one new thing Rada and Jonny really wanted to do.

They thought about it all night and didnâ€™t tell Mom and Dad about it.

It was their secret.

The next day, Radaâ€™s family got on a spaceship.

â€œItâ€™s going to be a long trip,â€ said Mom.

â€œThatâ€™s alright. Iâ€™m so excited!â€ said Rada.

The spaceship finally landed.

â€œDad, itâ€™s difficult to walk on Earth,â€ said Rada.

â€œI know. Earth is pulling you down,â€ said Dad.

Rada and Jonny couldnâ€™t float anymore. That was the first new thing.

â€œWhatâ€™s that sound?â€ asked Rada.

â€œA bird is singing,â€ said Mom.

â€œIâ€™ve never heard a bird sing,â€ said Rada.

â€œAnd Iâ€™ve never felt the wind,â€ said Jonny.

These were all new things.

Rada and Jonny ran up the nearest hill.

At the top, they looked at each other and laughed.

Then they lay down on the soft green grass and rolled down the hill.

That was their secret!
â€œThis is the best new thing of all!â€ shouted Rada and Jonny.

And they ran up to the top of the hill again.`;

        const LESSON_8_SCRIPT = `On May 27, 2011, 297 books of Uigwe*, a collection of royal books the French army took in 1866*, came back to Korea.

The person behind this return is Dr. Park Byeong-seon, a historian who spent her whole life searching for Korean national treasures abroad.

You found 297 books of Uigwe in the National Library of France, in Paris.

Please tell me how you found them.

Dr. Park: As soon as I became a researcher at the National Library in 1967, I began to look for Uigwe.

After 10 years, in 1977, I finally found the books.

I think I looked at more than 30 million books.

Iâ€™m sure you were very excited when you found the books.

Dr. Park: Yes, I was, but more difficulties were waiting for me.

I thought that the books should be returned to Korea, but my bosses at the library didnâ€™t like that idea.

They even thought that I was a Korean spy and fired me.

After that, I had to go to the library as a visitor, so it was not easy to do research on Uigwe.

However, I didnâ€™t give up.

For more than ten years, I went to the library every day to finish my research.

I wanted to show people the value of Uigwe.

The results of your research were published as a book in Korea in 1990.

Many Koreans became interested in Uigwe because of your book.

Dr. Park: Yes. In 1992, the Korean government asked the French government for its return and, finally, the 297 books are here now.

Before I finish this interview, Iâ€™d like to ask you about Jikji, a book that changed the history of printing.

Dr. Park: I found it in my first year at the library.

I knew right away that it was very special.

I worked hard to prove its value and finally succeeded.

At a book exhibition in Paris in 1972, Jikji* was displayed as the oldest book in the world that was printed with movable metal type.

Dr. Park, thanks to your hard work, Jikji and Uigwe were found, and all Koreans thank you for that.

Dr. Park: I hope people will become more interested in our national treasures abroad and work for their return.`;


        // ----------------------------------------------------------------------------------
        // --- TTS API Configuration (Azure/Edge TTS ëŒ€ì²´ ì•ˆë‚´) ---
        // ----------------------------------------------------------------------------------

        /* * [í˜„ì¬ í™˜ê²½ (Canvas) ì„¤ì •]
         * - ì´ í™˜ê²½ì—ì„œëŠ” ê³ í’ˆì§ˆ Gemini TTS APIë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
         * - ì´ ì½”ë“œëŠ” GitHubì— ë°°í¬í•  ë•Œ Azure/Edge TTS API ì‚¬ìš©ì„ ìœ„í•œ êµ¬ì¡°ë¥¼ ì‹œë®¬ë ˆì´ì…˜í•˜ê³  ì•ˆë‚´í•©ë‹ˆë‹¤.
         */
        const EXTERNAL_TTS_API_ENDPOINT = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=";
        const EXTERNAL_TTS_VOICE_NAME = "Kore"; // Gemini TTSì˜ ê³ í’ˆì§ˆ ì˜ì–´ ìŒì„±
        const API_KEY = ""; // Canvas í™˜ê²½ì—ì„œ ìë™ ì£¼ì…ë¨


        /*
         * [â˜… GitHub ë°°í¬ ì‹œ Azure/Edge TTSë¡œ ë³€ê²½í•˜ëŠ” ë°©ë²• - í•„ìˆ˜ ìˆ˜ì • ì‚¬í•­]
         * * 1. ì—”ë“œí¬ì¸íŠ¸ ë° ì¸ì¦ í‚¤ ì„¤ì • (ë³´ì•ˆ ì£¼ì˜!)
         * // ------------------------------------------------------------------------------------------------------
         * // GitHub ë°°í¬ ì‹œ ì•„ë˜ ë‘ ìƒìˆ˜ë¥¼ Azure Speech Service ì •ë³´ë¡œ êµì²´í•˜ê³ , API_KEY ëŒ€ì‹  í† í°ì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
         * // Azure ì—”ë“œí¬ì¸íŠ¸ëŠ” ë¦¬ì „ë³„ë¡œ ë‹¤ë¦…ë‹ˆë‹¤ (ì˜ˆ: westus.api.cognitive.microsoft.com/sts/v1.0/issueToken).
         * // CORS ë¬¸ì œ ë° API Key ë…¸ì¶œì„ ë§‰ê¸° ìœ„í•´, GitHub Pagesì—ì„œëŠ” **ë°˜ë“œì‹œ** Node.js ë“± ì„œë²„ë¥¼ ì‚¬ìš©í•˜ì—¬ 
         * // Azure ì¸ì¦ í† í°ì„ ë¨¼ì € ë°œê¸‰ë°›ì€ í›„, ê·¸ í† í°ì„ ì‚¬ìš©í•˜ì—¬ ì•„ë˜ APIë¥¼ í˜¸ì¶œí•´ì•¼ í•©ë‹ˆë‹¤.
         * // ------------------------------------------------------------------------------------------------------
         * // const AZURE_TTS_ENDPOINT = 'https://[Your Region].tts.speech.microsoft.com/cognitiveservices/v1';
         * // const AZURE_TOKEN_SERVICE = 'YOUR_PROXY_SERVER/token-service-url'; // (í† í° ë°œê¸‰ì„ ìœ„í•œ ì„œë²„ URL)
         * // const AZURE_TTS_VOICE = 'en-US-JennyNeural'; // Edge/Azureì˜ ê³ í’ˆì§ˆ ìŒì„±ìœ¼ë¡œ ë³€ê²½
         */
        
        let audioContext;
        let audioSource;

        /**
         * Base64 ë¬¸ìì—´ì„ ArrayBufferë¡œ ë³€í™˜í•©ë‹ˆë‹¤. (TTS APIì—ì„œ Base64ë¡œ ì¸ì½”ë”©ëœ PCM ë°ì´í„° ë°˜í™˜)
         */
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        /**
         * Signed 16-bit PCM ë°ì´í„°ë¥¼ WAV íŒŒì¼ í˜•ì‹ì˜ Blobìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
         */
        function pcmToWav(pcm16, sampleRate) {
            const numChannels = 1;
            const bitsPerSample = 16;
            const byteRate = sampleRate * numChannels * (bitsPerSample / 8);
            const blockAlign = numChannels * (bitsPerSample / 8);
            
            const buffer = new ArrayBuffer(44 + pcm16.length * 2); 
            const view = new DataView(buffer);
            let offset = 0;

            const writeString = (str) => {
                for (let i = 0; i < str.length; i++) {
                    view.setUint8(offset++, str.charCodeAt(i));
                }
            };
            
            const writeUint32 = (val) => {
                view.setUint32(offset, val, true);
                offset += 4;
            };

            const writeUint16 = (val) => {
                view.setUint16(offset, val, true);
                offset += 2;
            };

            // 1. RIFF chunk
            writeString('RIFF');
            writeUint32(36 + pcm16.length * 2); 
            writeString('WAVE');

            // 2. fmt chunk
            writeString('fmt ');
            writeUint32(16); 
            writeUint16(1); 
            writeUint16(numChannels); 
            writeUint32(sampleRate); 
            writeUint32(byteRate); 
            writeUint16(blockAlign); 
            writeUint16(bitsPerSample); 

            // 3. data chunk
            writeString('data');
            writeUint32(pcm16.length * 2); 

            // PCM ë°ì´í„° ë³µì‚¬
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(offset, pcm16[i], true);
                offset += 2;
            }

            return new Blob([view], { type: 'audio/wav' });
        }


        // --- Seeded Random Functions for Consistent Masking ---
        let prngSeed = 1;
        let ttsStatus = 'ready'; 

        /**
         * í…ìŠ¤íŠ¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¼ê´€ëœ ë‚œìˆ˜ ì‹œë“œë¥¼ ìƒì„±í•˜ëŠ” ê°„ë‹¨í•œ í•´ì‹œ í•¨ìˆ˜
         */
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = (hash << 5) - hash + char;
                hash |= 0;
            }
            return Math.abs(hash);
        }

        /**
         * ë‚œìˆ˜ ìƒì„±ê¸° ì´ˆê¸°í™”
         */
        function seedPrng(seed) {
            prngSeed = seed % 2147483647;
            if (prngSeed <= 0) prngSeed = 1;
        }

        /**
         * ë‹¤ìŒ ë‚œìˆ˜ (0 ~ 1) ìƒì„±
         */
        function nextPrng() {
            prngSeed = (prngSeed * 16807) % 2147483647;
            return (prngSeed - 1) / 2147483646;
        }

        /**
         * ì‹œë“œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¼ê´€ì„± ìˆê²Œ ë°°ì—´ì„ ì„ëŠ” Fisher-Yates shuffle
         */
        function seededShuffle(array) {
            const shuffled = [...array];
            const initialSeed = simpleHash(originalText);
            seedPrng(initialSeed);

            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(nextPrng() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // ë¬¸ì¥ ë¶„ë¦¬ ìœ í‹¸ë¦¬í‹°: ê°œí–‰ì„ ê³µë°±ìœ¼ë¡œ ì •ê·œí™” í›„ .?! ë° ë”°ì˜´í‘œë¥¼ í¬í•¨í•´ ë¶„ë¦¬
        function splitIntoSentences(str) {
            const normalized = str.replace(/\s*\n\s*/g, ' ');
            const matches = normalized.match(/[^.!?]+[.!?](?:["â€â€™']+)?|[^.!?]+$/g) || [];
            return matches.map(s => s.trim()).filter(Boolean);
        }

        // --- ì „ì—­ ìƒíƒœ ë° ìƒìˆ˜ ---
        let originalText = "";
        let currentLessonTitle = "";
        let wordElements = [];
        let globallyMaskableIndices = [];
        let currentMaskedIndices = new Set();
        let sentences = [];
        
        let difficultyLevel = 0;
        let isAnswerVisible = false;

        let chunks = [];
        const chunksPerPage = 5;
        let currentPage = 1;
        let totalPages = 1;

        const difficultyMap = {
            0: { percentage: 0, label: "ì‰¬ì›€" },
            1: { percentage: 20, label: "ì•½ê°„ ì‰¬ì›€" },
            2: { percentage: 40, label: "ë³´í†µ" },
            3: { percentage: 60, label: "ì•½ê°„ ì–´ë ¤ì›€" },
            4: { percentage: 80, label: "ì–´ë ¤ì›€" },
            5: { percentage: 100, label: "ì „ì²´ ê°€ë¦¼" }
        };

        const inputSection = document.getElementById('input-section');
        const memorizationSection = document.getElementById('memorization-section');
        const textDisplayArea = document.getElementById('text-display-area');
        const difficultyDisplay = document.getElementById('current-difficulty-display');
        const toggleAnswerBtn = document.getElementById('toggle-answer-btn');
        const currentPageDisplay = document.getElementById('current-page-display');
        const totalPagesDisplay = document.getElementById('total-pages-display');
        const prevPageBtn = document.getElementById('prev-page-btn');
        const nextPageBtn = document.getElementById('next-page-btn');
        const audioBtn = document.getElementById('audio-btn');
        const ttsStatusMessage = document.getElementById('tts-status-message');
        const ttsStatusMessageInitial = document.getElementById('tts-status-message-initial');
        const lessonTitleEl = document.getElementById('lesson-title');


        /**
         * ì„ íƒëœ í…ìŠ¤íŠ¸ë¥¼ ì²˜ë¦¬í•˜ê³  ì•”ê¸° ëª¨ë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.
         */
        function processText(rawText, title) {
            const textOrArray = Array.isArray(rawText) ? rawText : rawText.trim().replace(/\r\n/g, '\n');
            if (!Array.isArray(rawText) && textOrArray.length < 10) {
                displayMessage("ì„ íƒëœ ë³¸ë¬¸ì´ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤.", "error");
                return;
            }

            stopSpeaking();
            
            // í•œ ë¬¸ì¥ì”© ë°°ì—´ë¡œ ë¶„ë¦¬í•˜ì—¬ ì‚¬ìš©
            if (Array.isArray(textOrArray)) {
                sentences = textOrArray.map(s => String(s).trim()).filter(Boolean);
            } else {
                sentences = textOrArray.split(/\n{2,}/).map(s => s.trim()).filter(Boolean);
                if (!sentences.length) {
                    sentences = splitIntoSentences(textOrArray);
                }
            }
            originalText = sentences.join('\n\n');
            currentLessonTitle = title;
            lessonTitleEl.textContent = `2ë‹¨ê³„: ${currentLessonTitle} ì™¸ìš°ê¸°`;
            
            // 1. í˜ì´ì§€ ì²­í¬ëŠ” ë¬¸ì¥ ë°°ì—´ ìì²´ë¥¼ ì‚¬ìš©
            chunks = [...sentences];
            totalPages = Math.ceil(chunks.length / chunksPerPage);
            currentPage = 1;
            
            // 2. ì „ì²´ ë‹¨ì–´ë¥¼ í† í°í™”í•˜ê³  ë§ˆìŠ¤í‚¹ ê°€ëŠ¥í•œ ì¸ë±ìŠ¤ ì¶”ì¶œ
            prepareWords(); 
            
            // 3. ë‚œì´ë„ ì´ˆê¸°í™” ë° ë§ˆìŠ¤í‚¹ ì¸ë±ìŠ¤ ì—…ë°ì´íŠ¸
            setDifficulty(0); 

            // 4. UI ìƒíƒœ ì „í™˜
            isAnswerVisible = false;
            inputSection.classList.add('hidden');
            memorizationSection.classList.remove('hidden');
            
            updateToggleAnswerButton();
            renderPage();
            updateAudioButton(); 
            updatePaginationControls();
        }

        /**
         * í…ìŠ¤íŠ¸ë¥¼ ë‹¨ì–´ì™€ êµ¬ë¶„ ê¸°í˜¸ë¡œ ë¶„ë¦¬í•˜ê³ , ë§ˆìŠ¤í‚¹ ê°€ëŠ¥í•œ ë‹¨ì–´ ì¸ë±ìŠ¤ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.
         */
        function prepareWords() {
            const regex = /([a-zA-Z0-9]+|[^a-zA-Z0-9\s]+|\s+)/g;
            wordElements = [];
            globallyMaskableIndices = [];
            let sentenceIndex = 0;
            for (const s of sentences) {
                let match;
                while ((match = regex.exec(s)) !== null) {
                    const element = match[0];
                    const isWord = /[a-zA-Z0-9]/.test(element) && element.length > 1;
                    wordElements.push({
                        text: element.trim() === '' ? ' ' : element,
                        isWord,
                        chunkIndex: sentenceIndex,
                        globalIndex: wordElements.length
                    });
                    if (isWord) globallyMaskableIndices.push(wordElements.length - 1);
                }
                sentenceIndex++;
            }
        }

        /**
         * í˜„ì¬ ë‚œì´ë„ì— ë”°ë¼ ë§ˆìŠ¤í‚¹í•  ë‹¨ì–´ ì¸ë±ìŠ¤ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        function updateMaskedIndices() {
            const { percentage } = difficultyMap[difficultyLevel];
            
            const maxMaskable = globallyMaskableIndices.length;
            const wordsToHide = Math.ceil(maxMaskable * (percentage / 100));

            const shuffledIndices = seededShuffle(globallyMaskableIndices);

            const selectedIndices = shuffledIndices.slice(0, wordsToHide);

            currentMaskedIndices = new Set(selectedIndices);
        }
        
        /**
         * í˜„ì¬ í˜ì´ì§€ì— í•´ë‹¹í•˜ëŠ” í…ìŠ¤íŠ¸ë¥¼ HTMLë¡œ ë Œë”ë§í•©ë‹ˆë‹¤.
         */
        function renderPage() {
            if (!wordElements.length) return;

            const startChunkIndex = (currentPage - 1) * chunksPerPage;
            const endChunkIndex = currentPage * chunksPerPage - 1;

            // ë¬¸ì¥(ì²­í¬) ë‹¨ìœ„ë¡œ ë¬¶ì–´ì„œ ë Œë”ë§, ê° ë¬¸ì¥ ì•ì— ìŠ¤í”¼ì»¤ ì•„ì´ì½˜ ì¶”ê°€
            let html = '';
            for (let ci = startChunkIndex; ci <= endChunkIndex; ci++) {
                const sentenceElements = wordElements.filter(el => el.chunkIndex === ci);
                if (!sentenceElements.length) {
                    html += `<div class="sentence-row"><div class="sentence-text">&nbsp;</div></div>`;
                    continue;
                }
                const sentenceHtml = sentenceElements.map((element) => {
                    if (element.text === '\n') return '';
                    if (element.text === ' ') return element.text;
                    if (element.isWord && currentMaskedIndices.has(element.globalIndex)) {
                        const blankLength = element.text.length > 5 ? '____' : '___';
                        const displayContent = isAnswerVisible ? element.text : blankLength;
                        const answerClass = isAnswerVisible ? ' show-answer' : '';
                        return `<span class="masked-word${answerClass}">${displayContent}</span>`;
                    }
                    return element.text;
                }).join('');
                html += `<div class="sentence-row"><button class="sentence-speaker" onclick="speakSentence(${ci})" title="ì´ ë¬¸ì¥ ë“£ê¸°">ğŸ”Š</button><div class="sentence-text">${sentenceHtml}</div></div>`;
            }

            textDisplayArea.innerHTML = html;
            updatePaginationControls();
        }

        /**
         * ë‚œì´ë„ë¥¼ ì„¤ì •í•˜ê³  í…ìŠ¤íŠ¸ë¥¼ ë‹¤ì‹œ ë Œë”ë§í•©ë‹ˆë‹¤.
         */
        function setDifficulty(level) {
            difficultyLevel = level;
            stopSpeaking();
            updateMaskedIndices();
            isAnswerVisible = false;
            updateToggleAnswerButton();
            renderPage();
            updateDifficultyDisplay();
        }

        /**
         * ì •ë‹µ ë³´ê¸°/ìˆ¨ê¸°ê¸° ìƒíƒœë¥¼ ì „í™˜í•˜ê³  í…ìŠ¤íŠ¸ë¥¼ ë‹¤ì‹œ ë Œë”ë§í•©ë‹ˆë‹¤.
         */
        function toggleAnswer() {
            isAnswerVisible = !isAnswerVisible;
            updateToggleAnswerButton();
            renderPage();
        }

        /**
         * ë‚œì´ë„ í‘œì‹œ UIë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        function updateDifficultyDisplay() {
            const { percentage, label } = difficultyMap[difficultyLevel];
            difficultyDisplay.textContent = `ë‚œì´ë„: ${label} (${percentage}% ê°€ë¦¼)`;
        }

        /**
         * ì •ë‹µ ë³´ê¸° ë²„íŠ¼ í…ìŠ¤íŠ¸ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        function updateToggleAnswerButton() {
            toggleAnswerBtn.textContent = isAnswerVisible ? 'ì •ë‹µ ìˆ¨ê¸°ê¸°' : 'ì •ë‹µ ë³´ê¸°';
        }

        // --- í˜ì´ì§€ë„¤ì´ì…˜ í•¨ìˆ˜ ---
        function goToPrevPage() {
            stopSpeaking();
            if (currentPage > 1) {
                currentPage--;
                renderPage();
            }
        }

        function goToNextPage() {
            stopSpeaking();
            if (currentPage < totalPages) {
                currentPage++;
                renderPage();
            }
        }
        
        function updatePaginationControls() {
            currentPageDisplay.textContent = currentPage;
            totalPagesDisplay.textContent = totalPages;

            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages;
        }


        // --- TTS (ìŒì„± ë“£ê¸°) í•¨ìˆ˜ ---
        
        /**
         * í˜„ì¬ í˜ì´ì§€ì˜ ì›ë¬¸ í…ìŠ¤íŠ¸ë¥¼ ì½ì–´ì¤ë‹ˆë‹¤.
         */
        async function speakCurrentPage() {
            if (ttsStatus === 'generating' || ttsStatus === 'playing') {
                stopSpeaking();
                return;
            }

            ttsStatus = 'generating';
            updateAudioButton();

            // í˜„ì¬ í˜ì´ì§€ì˜ ì›ë¬¸ í…ìŠ¤íŠ¸ ì¶”ì¶œ
            const startChunkIndex = (currentPage - 1) * chunksPerPage;
            const endChunkIndex = Math.min(currentPage * chunksPerPage, chunks.length);
            const pageText = chunks.slice(startChunkIndex, endChunkIndex).join(' ');

            if (pageText.trim().length === 0) {
                displayMessage("ì½ì–´ì¤„ í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.", "warning");
                ttsStatus = 'ready';
                updateAudioButton();
                return;
            }

            // ----------------------------------------------------------------------------------
            // [Azure/Edge TTS SSML ìš”ì²­ êµ¬ì¡° ì˜ˆì‹œ (GitHub ë°°í¬ ì‹œ ì°¸ê³ )]
            /*
            const AZURE_SSML = `<speak version='1.0' xml:lang='en-US'>
                <voice name='en-US-JennyNeural'>${pageText}</voice>
            </speak>`;

            const AZURE_HEADERS = {
                'X-Microsoft-OutputFormat': 'audio-16khz-32kbitrate-mono-mp3',
                'Content-Type': 'application/ssml+xml',
                // 'Authorization': 'Bearer YOUR_TOKEN_FROM_TOKEN_SERVICE' // GitHub ë°°í¬ ì‹œ í•„ìˆ˜
            };
            
            const AZURE_ENDPOINT = 'YOUR_AZURE_REGION_ENDPOINT/v1/synthesize';
            */
            // ----------------------------------------------------------------------------------

            // ì„ í˜¸ ìˆœì„œ: Google TTS(ì‚¬ìš© ì„¤ì • ì‹œ) â†’ Gemini TTS â†’ ë¸Œë¼ìš°ì € TTS
            const hasGoogleKey = typeof GOOGLE_TTS_API_KEY === 'string' && GOOGLE_TTS_API_KEY.trim().length > 0;
            const useGoogleTts = typeof USE_GOOGLE_TTS !== 'undefined' ? USE_GOOGLE_TTS : false;
            if (useGoogleTts && hasGoogleKey) {
                const ok = await speakWithGoogleTTS(pageText);
                if (ok) return;
            }
            const hasApiKey = typeof API_KEY === 'string' && API_KEY.trim().length > 0;
            if (!hasApiKey) {
                webSpeechSpeak(pageText);
                return;
            }

            // í˜„ì¬ í™˜ê²½(Canvas)ì—ì„œëŠ” Gemini TTS API ì‚¬ìš© (Azure êµ¬ì¡°ë¥¼ ëŒ€ì²´)
            const payload = {
                contents: [{ parts: [{ text: pageText }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: EXTERNAL_TTS_VOICE_NAME }
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            const apiUrlWithKey = `${EXTERNAL_TTS_API_ENDPOINT}${API_KEY}`;
            let retries = 0;
            const maxRetries = 2;

            while (retries < maxRetries) {
                try {
                    const response = await fetch(apiUrlWithKey, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API returned status ${response.status}`);
                    }

                    const result = await response.json();
                    const part = result?.candidates?.[0]?.content?.parts?.[0];
                    const audioData = part?.inlineData?.data;
                    const mimeType = part?.inlineData?.mimeType;

                    if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                        const rateMatch = mimeType.match(/rate=(\d+)/);
                        const sampleRate = rateMatch ? parseInt(rateMatch[1], 10) : 16000;
                        const pcmData = base64ToArrayBuffer(audioData);
                        const pcm16 = new Int16Array(pcmData);
                        const wavBlob = pcmToWav(pcm16, sampleRate);
                        const audioUrl = URL.createObjectURL(wavBlob);
                        playAudio(audioUrl);
                        return;
                    } else {
                        throw new Error("Invalid audio data received or Azure response handling needed.");
                    }
                } catch (error) {
                    displayMessage(`TTS API í˜¸ì¶œ ì˜¤ë¥˜ (ì¬ì‹œë„ ${retries + 1}): ${error.message}`, "error");
                    retries++;
                    if (retries < maxRetries) {
                        const delay = Math.pow(2, retries) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }

            // ëª¨ë“  ì¬ì‹œë„ ì‹¤íŒ¨ ì‹œ ë¸Œë¼ìš°ì € TTSë¡œ í´ë°±
            webSpeechSpeak(pageText);
        }

        /**
         * ì˜¤ë””ì˜¤ URLì„ ì‚¬ìš©í•˜ì—¬ ì¬ìƒí•˜ê³  ìƒíƒœë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.
         */
        function playAudio(audioUrl) {
            stopSpeaking(); // ì´ì „ì— ì¬ìƒ ì¤‘ì´ë˜ ì˜¤ë””ì˜¤ ì¤‘ì§€

            audioContext = new Audio();
            audioContext.src = audioUrl;
            
            audioContext.onplay = () => { ttsStatus = 'playing'; updateAudioButton(); };
            audioContext.onended = () => { ttsStatus = 'ready'; updateAudioButton(); URL.revokeObjectURL(audioUrl); };
            audioContext.onerror = (e) => { 
                displayMessage(`Audio playback error: ${e.message || 'Unknown error'}`, "error"); 
                ttsStatus = 'error'; 
                updateAudioButton();
                URL.revokeObjectURL(audioUrl);
            };

            audioContext.play().catch(e => {
                displayMessage(`Audio playback initiation failed: ${e.message}`, "error");
                ttsStatus = 'error';
                updateAudioButton();
                URL.revokeObjectURL(audioUrl);
            });
        }

        /**
         * ìŒì„± ì¬ìƒì„ ì¤‘ì§€í•©ë‹ˆë‹¤.
         */
        function stopSpeaking() {
            if (audioContext) {
                audioContext.pause();
                audioContext.currentTime = 0;
                audioContext = null;
            }
            try { if (window.speechSynthesis) { window.speechSynthesis.cancel(); } } catch (_) {}
            if (ttsStatus === 'generating') {
                 displayMessage("TTS ìƒì„± ì¤‘ë‹¨ë¨.", "info");
            }
            ttsStatus = 'ready';
            updateAudioButton();
        }

        /**
         * ë¸Œë¼ìš°ì € Web Speech APIë¥¼ ì‚¬ìš©í•œ í´ë°± ì¬ìƒ
         */
        function webSpeechSpeak(text) {
            if (!('speechSynthesis' in window)) {
                displayMessage('ë¸Œë¼ìš°ì € TTS ë¯¸ì§€ì›. ì™¸ë¶€ TTS í‚¤ë¥¼ ì„¤ì •í•˜ì„¸ìš”.', 'error');
                ttsStatus = 'error';
                updateAudioButton();
                return;
            }
            stopSpeaking();
            const sentences = text.split(/\n+/).map(s => s.trim()).filter(Boolean);

            const getBestEnglishVoice = () => {
                const voices = window.speechSynthesis.getVoices();
                const english = voices.filter(v => /^en(-|_)/i.test(v.lang));
                const preferredPatterns = [
                    /Microsoft.*Aria/i,
                    /Microsoft.*Guy/i,
                    /Microsoft.*Jenny/i,
                    /Google US English/i,
                    /Google UK English/i,
                    /Samantha/i,
                    /Daniel/i
                ];
                for (const pat of preferredPatterns) {
                    const found = english.find(v => pat.test(v.name));
                    if (found) return found;
                }
                return english[0] || voices[0] || null;
            };

            let idx = 0;
            const speakNext = () => {
                if (idx >= sentences.length) {
                    ttsStatus = 'ready';
                    updateAudioButton();
                    return;
                }
                const utter = new SpeechSynthesisUtterance(sentences[idx]);
                const voice = getBestEnglishVoice();
                if (voice) {
                    utter.voice = voice;
                    utter.lang = voice.lang;
                } else {
                    utter.lang = 'en-US';
                }
                utter.rate = 0.95;
                utter.pitch = 1.0;
                utter.onstart = () => { ttsStatus = 'playing'; updateAudioButton(); };
                utter.onend = () => { setTimeout(() => { idx++; speakNext(); }, 220); };
                utter.onerror = (e) => {
                    displayMessage(`Web Speech ì˜¤ë¥˜: ${e.error || e.message || 'Unknown'}`, 'error');
                    ttsStatus = 'error';
                    updateAudioButton();
                };
                window.speechSynthesis.speak(utter);
            };

            speakNext();
        }

        // --- Google Cloud Text-to-Speech ì„¤ì • ë° í˜¸ì¶œ ---
        const GOOGLE_TTS_API_ENDPOINT = 'https://texttospeech.googleapis.com/v1/text:synthesize?key=';
        const GOOGLE_TTS_VOICE = 'en-US-Neural2-D';
        const GOOGLE_TTS_API_KEY = '';
        const USE_GOOGLE_TTS = true;

        async function speakWithGoogleTTS(text) {
            try {
                const payload = {
                    input: { text },
                    voice: { languageCode: 'en-US', name: GOOGLE_TTS_VOICE },
                    audioConfig: { audioEncoding: 'MP3', speakingRate: 1.0, pitch: 0.0 }
                };
                const url = `${GOOGLE_TTS_API_ENDPOINT}${GOOGLE_TTS_API_KEY}`;
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) throw new Error(`Google TTS ${res.status}`);
                const data = await res.json();
                const audioContent = data?.audioContent;
                if (!audioContent) throw new Error('No audioContent');
                const buf = base64ToArrayBuffer(audioContent);
                const blob = new Blob([buf], { type: 'audio/mp3' });
                const urlObj = URL.createObjectURL(blob);
                playAudio(urlObj);
                return true;
            } catch (e) {
                displayMessage(`Google TTS ì˜¤ë¥˜: ${e.message}`, 'error');
                return false;
            }
        }

        /**
         * ìŒì„± ë²„íŠ¼ì˜ ìƒíƒœë¥¼ í† ê¸€í•©ë‹ˆë‹¤.
         */
        function toggleAudio() {
            if (ttsStatus === 'playing' || ttsStatus === 'generating') {
                stopSpeaking();
            } else if (ttsStatus === 'ready') {
                speakCurrentPage();
            }
        }
        
        // ë¬¸ì¥ë³„ ìŠ¤í”¼ì»¤ ì•„ì´ì½˜ í´ë¦­ ì‹œ í•´ë‹¹ ë¬¸ì¥ë§Œ ì¬ìƒ
        async function speakSentence(chunkIndex) {
            stopSpeaking();
            const idx = Number(chunkIndex);
            if (Number.isNaN(idx) || idx < 0 || idx >= chunks.length) {
                displayMessage('ì˜ëª»ëœ ë¬¸ì¥ ì¸ë±ìŠ¤ì…ë‹ˆë‹¤.', 'error');
                return;
            }
            const sentence = chunks[idx];
            if (!sentence || !sentence.trim()) {
                displayMessage('ì¬ìƒí•  ë¬¸ì¥ì´ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                return;
            }
            ttsStatus = 'generating';
            updateAudioButton();
            const hasGoogleKey = typeof GOOGLE_TTS_API_KEY === 'string' && GOOGLE_TTS_API_KEY.trim().length > 0;
            if (USE_GOOGLE_TTS && hasGoogleKey) {
                const ok = await speakWithGoogleTTS(sentence);
                if (ok) return;
            }
            const hasApiKey = typeof API_KEY === 'string' && API_KEY.trim().length > 0;
            if (hasApiKey) {
                // Geminië¡œ í´ë°±
                const payload = {
                    contents: [{ parts: [{ text: sentence }] }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: EXTERNAL_TTS_VOICE_NAME } } }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };
                try {
                    const response = await fetch(`${EXTERNAL_TTS_API_ENDPOINT}${API_KEY}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (response.ok) {
                        const result = await response.json();
                        const part = result?.candidates?.[0]?.content?.parts?.[0];
                        const audioData = part?.inlineData?.data;
                        const mimeType = part?.inlineData?.mimeType;
                        if (audioData && mimeType && mimeType.startsWith('audio/L16')) {
                            const rateMatch = mimeType.match(/rate=(\d+)/);
                            const sampleRate = rateMatch ? parseInt(rateMatch[1], 10) : 16000;
                            const pcmData = base64ToArrayBuffer(audioData);
                            const pcm16 = new Int16Array(pcmData);
                            const wavBlob = pcmToWav(pcm16, sampleRate);
                            const audioUrl = URL.createObjectURL(wavBlob);
                            playAudio(audioUrl);
                            return;
                        }
                    }
                } catch (e) {
                    displayMessage(`Gemini TTS ì˜¤ë¥˜: ${e.message}`, 'error');
                }
            }
            webSpeechSpeak(sentence);
        }
        
        /**
         * ìŒì„± ë²„íŠ¼ì˜ í…ìŠ¤íŠ¸ì™€ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        function updateAudioButton() {
            let buttonText = '';
            let isDisabled = false;

            if (ttsStatus === 'generating') {
                buttonText = '... ìŒì„± ìƒì„± ì¤‘';
                isDisabled = true;
            } else if (ttsStatus === 'playing') {
                buttonText = 'â¹ï¸ ìŒì„± ì¤‘ì§€';
                isDisabled = false;
            } else if (ttsStatus === 'error') {
                buttonText = 'TTS ì˜¤ë¥˜';
                isDisabled = true;
            } else { // ready
                buttonText = 'ğŸ”Š ìŒì„± ë“£ê¸°';
                isDisabled = false;
            }

            audioBtn.textContent = buttonText;
            audioBtn.disabled = isDisabled;

            // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
            const targetMessageEl = memorizationSection.classList.contains('hidden') ? ttsStatusMessageInitial : ttsStatusMessage;
            
            targetMessageEl.classList.remove('hidden', 'status-error', 'status-loading');

            if (ttsStatus === 'generating') {
                targetMessageEl.classList.add('status-loading');
                targetMessageEl.textContent = 'ğŸ”Š ê³ í’ˆì§ˆ ìŒì„±ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.';
            } else if (ttsStatus === 'error') {
                targetMessageEl.classList.add('status-error');
                targetMessageEl.textContent = 'TTS ì˜¤ë¥˜ ë°œìƒ. ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜ ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.';
            } else {
                targetMessageEl.classList.add('hidden');
            }
        }


        /**
         * ì•±ì„ ì´ˆê¸° ìƒíƒœë¡œ ë˜ëŒë¦½ë‹ˆë‹¤.
         */
        function resetApp() {
            stopSpeaking();
            originalText = "";
            currentLessonTitle = "";
            wordElements = [];
            globallyMaskableIndices = [];
            currentMaskedIndices = new Set();
            difficultyLevel = 0;
            isAnswerVisible = false;
            currentPage = 1;
            totalPages = 1;
            chunks = [];
            
            textDisplayArea.innerHTML = "ì—¬ê¸°ì— ì•”ê¸°í•  ë³¸ë¬¸ì´ í‘œì‹œë©ë‹ˆë‹¤.";

            // UI ìƒíƒœ ì „í™˜
            memorizationSection.classList.add('hidden');
            inputSection.classList.remove('hidden');
            
            updateAudioButton();
            displayMessage("ìƒˆë¡œìš´ ê³¼ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.", "info");
        }

        /**
         * ì‚¬ìš©ìì—ê²Œ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤ (ì½˜ì†”ì— ì¶œë ¥).
         */
        function displayMessage(message, type = "info") {
            const style = type === "error" ? "color: red; font-weight: bold;" : type === "warning" ? "color: orange;" : "color: blue;";
            console.log(`%c[APP MESSAGE]: ${message}`, style);
        }

        // ì´ˆê¸° ë¡œë“œ ì‹œ ì‹¤í–‰
        window.onload = function() {
            updateAudioButton();
        };

    </script>

</body>
</html>